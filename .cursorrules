# =============================================================================
# CURSORRULES - MediaBib
# Système Intégré de Gestion de Bibliothèque
# =============================================================================

## CONTEXTE DU PROJET

MediaBib est un SIGB (Système Intégré de Gestion de Bibliothèque) open source,
clone de PMB, développé avec Django 5.2+ et Python 3.10+.

Stack technique :
- Backend : Django 5.2, Python 3.10+
- Base de données : PostgreSQL (production), SQLite (développement)
- Frontend : HTML5, CSS3 (Tailwind/Bootstrap), JavaScript vanilla
- Serveur : Gunicorn + Nginx
- Normes : UNIMARC, Z39.50, SRU/SRW, SIP2

---

## 1. LANGUE ET COMMUNICATION

- Toujours répondre en français
- Utiliser un vocabulaire technique approprié au domaine des bibliothèques
- Commenter le code en français
- Nommer les variables et fonctions en anglais (convention Python)

---

## 2. ACCESSIBILITÉ (WCAG 2.1 AA / RGAA)

### Obligations strictes :

- **ARIA** : Ajouter les attributs ARIA sur tous les éléments interactifs
  - `aria-label` pour les boutons sans texte visible
  - `aria-describedby` pour les messages d'erreur
  - `aria-live="polite"` pour les contenus dynamiques
  - `aria-expanded` pour les menus déroulants
  - `role="alert"` pour les messages d'erreur critiques

- **Navigation clavier** :
  - Tous les éléments interactifs accessibles via Tab
  - Ordre de tabulation logique (tabindex si nécessaire)
  - Focus visible sur tous les éléments (:focus-visible)
  - Gestion Escape pour fermer les modales/menus

- **Skip links** : Inclure "Aller au contenu principal" en haut de chaque page

- **Formulaires** :
  - Chaque input DOIT avoir un label associé (for/id)
  - Champs obligatoires marqués avec aria-required="true"
  - Messages d'erreur liés au champ via aria-describedby
  - Ne pas utiliser uniquement la couleur pour indiquer les erreurs

- **Contraste** :
  - Minimum 4.5:1 pour le texte normal
  - Minimum 3:1 pour le texte large (18px+ ou 14px bold)
  - Minimum 3:1 pour les éléments d'interface

- **Images** : Toujours inclure un attribut alt descriptif

- **Structure** :
  - Une seule balise <h1> par page
  - Hiérarchie des titres respectée (h1 > h2 > h3...)
  - Utiliser les balises sémantiques : <main>, <nav>, <header>, <footer>, <article>, <section>

### Exemple de formulaire accessible :

```html
<div class="form-group">
  <label for="email" id="email-label">
    Adresse email <span aria-hidden="true">*</span>
  </label>
  <input 
    type="email" 
    id="email" 
    name="email"
    aria-required="true"
    aria-describedby="email-error email-help"
    aria-invalid="false"
  >
  <p id="email-help" class="help-text">Format : exemple@domaine.fr</p>
  <p id="email-error" class="error-text" role="alert" hidden></p>
</div>
```

---

## 3. SÉCURITÉ

### Obligations strictes :

- **CSRF** : Toujours utiliser {% csrf_token %} dans les formulaires POST
- **XSS** : Ne jamais utiliser |safe sans validation préalable
- **Injection SQL** : Utiliser l'ORM Django, jamais de raw SQL sans paramètres
- **Validation** : Valider TOUTES les entrées utilisateur côté serveur
- **Secrets** : Jamais de secrets dans le code, utiliser python-decouple
- **Mots de passe** : Utiliser les validateurs Django (min 8 caractères, complexité)

### Sessions et authentification :

- Expiration de session après 30 minutes d'inactivité
- Régénérer l'ID de session après connexion
- Logs de connexion (succès et échecs)
- Blocage après 5 tentatives échouées

### Headers de sécurité (déjà configurés en production) :

- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Strict-Transport-Security (HSTS)
- Content-Security-Policy si applicable

### Exemple de vue sécurisée :

```python
from django.contrib.auth.decorators import login_required, permission_required
from django.views.decorators.http import require_http_methods

@login_required
@permission_required('catalog.add_record', raise_exception=True)
@require_http_methods(["GET", "POST"])
def create_record(request):
    # Validation côté serveur obligatoire
    pass
```

---

## 4. RESPONSIVE DESIGN

### Approche mobile-first :

- Écrire d'abord les styles pour mobile
- Utiliser min-width dans les media queries
- Tester sur : 320px, 768px, 1024px, 1440px

### Breakpoints standards :

```css
/* Mobile first */
.element { /* styles mobile */ }

@media (min-width: 768px) {
  .element { /* styles tablette */ }
}

@media (min-width: 1024px) {
  .element { /* styles desktop */ }
}

@media (min-width: 1440px) {
  .element { /* styles grand écran */ }
}
```

### Obligations :

- Menu hamburger pour mobile
- Tableaux scrollables horizontalement sur mobile
- Images responsive avec srcset ou max-width: 100%
- Boutons suffisamment grands (min 44x44px pour le touch)
- Pas de scroll horizontal non voulu

---

## 5. CODE PYTHON / DJANGO

### Style et conventions :

- Suivre PEP 8 strictement
- Ligne max : 88 caractères (Black)
- Utiliser Black pour le formatage automatique
- Utiliser isort pour les imports
- Utiliser flake8 pour le linting

### Docstrings obligatoires :

```python
def calculate_fine(loan: Loan, return_date: date) -> Decimal:
    """
    Calcule l'amende pour un prêt en retard.

    Args:
        loan: L'objet Loan concerné
        return_date: La date de retour effective

    Returns:
        Le montant de l'amende en euros (Decimal)

    Raises:
        ValueError: Si la date de retour est antérieure à la date de prêt
    """
    pass
```

### Django - Bonnes pratiques :

- Utiliser les Class-Based Views (CBV) par défaut
- Optimiser les requêtes avec select_related() et prefetch_related()
- Utiliser les managers personnalisés pour les requêtes complexes
- Séparer la logique métier dans des services (services.py)
- Utiliser les signaux avec parcimonie

### Structure d'une application Django :

```
app_name/
├── __init__.py
├── admin.py
├── apps.py
├── forms.py
├── models.py
├── services.py      # Logique métier
├── urls.py
├── views.py
├── managers.py      # Managers personnalisés
├── signals.py       # Signaux si nécessaire
├── templates/
│   └── app_name/
├── static/
│   └── app_name/
├── tests/
│   ├── __init__.py
│   ├── test_models.py
│   ├── test_views.py
│   ├── test_forms.py
│   └── test_services.py
└── migrations/
```

### Exemple de CBV avec permissions :

```python
from django.contrib.auth.mixins import LoginRequiredMixin, PermissionRequiredMixin
from django.views.generic import CreateView

class RecordCreateView(LoginRequiredMixin, PermissionRequiredMixin, CreateView):
    """Vue de création d'une notice bibliographique."""
    
    model = BibliographicRecord
    form_class = RecordForm
    template_name = 'catalog/record_form.html'
    permission_required = 'catalog.add_bibliographicrecord'
    
    def form_valid(self, form):
        """Ajoute l'utilisateur créateur avant sauvegarde."""
        form.instance.created_by = self.request.user
        return super().form_valid(form)
```

---

## 6. TESTS OBLIGATOIRES

### Règle absolue : Pas de code sans tests !

Chaque fonctionnalité DOIT être accompagnée de tests. C'est une condition non négociable.

### Quand écrire des tests :

1. **Nouvelle fonctionnalité** : Tests AVANT ou PENDANT le développement (TDD encouragé)
2. **Modification de code existant** : Adapter/ajouter des tests pour couvrir les changements
3. **Correction de bug** : Écrire un test qui reproduit le bug AVANT de le corriger
4. **Refactoring** : S'assurer que les tests existants passent toujours

### Processus obligatoire :

```
┌─────────────────────────────────────────────────────────────┐
│  1. Écrire/modifier le code                                 │
│  2. Écrire/adapter les tests correspondants                 │
│  3. Vérifier que tous les tests passent (pytest)            │
│  4. Vérifier la couverture (coverage >= 80%)                │
│  5. Commit uniquement si tests OK                           │
└─────────────────────────────────────────────────────────────┘
```

### Couverture obligatoire :

- Minimum 80% de couverture de code globale
- 100% de couverture sur les nouvelles fonctionnalités
- Tests unitaires + tests d'intégration

### Types de tests requis par fonctionnalité :

| Composant | Tests requis |
|-----------|--------------|
| Modèle | Validation, méthodes, propriétés, managers |
| Vue | Permissions, GET, POST, redirections, contexte |
| Formulaire | Validation, champs requis, clean methods |
| Service | Logique métier, cas limites, exceptions |
| API | Endpoints, authentification, sérialisation |
| Template | Rendu, éléments présents (optionnel) |

### Outils :

- pytest + pytest-django
- factory-boy pour les fixtures
- coverage pour la couverture
- pytest-cov pour le rapport intégré

### Commandes à exécuter :

```bash
# Lancer tous les tests
pytest

# Avec couverture
pytest --cov=. --cov-report=html

# Tests d'une application spécifique
pytest catalog/tests/

# Tests en mode verbose
pytest -v

# Arrêter au premier échec
pytest -x
```

### Structure des tests :

```python
import pytest
from django.urls import reverse

@pytest.mark.django_db
class TestRecordCreateView:
    """Tests pour la vue de création de notice."""

    def test_anonymous_user_redirected_to_login(self, client):
        """Un utilisateur non connecté est redirigé vers le login."""
        url = reverse('catalog:record-create')
        response = client.get(url)
        assert response.status_code == 302
        assert '/login/' in response.url

    def test_user_without_permission_gets_403(self, client, reader_user):
        """Un lecteur sans permission reçoit une erreur 403."""
        client.force_login(reader_user)
        url = reverse('catalog:record-create')
        response = client.get(url)
        assert response.status_code == 403

    def test_librarian_can_create_record(self, client, librarian_user):
        """Un bibliothécaire peut créer une notice."""
        client.force_login(librarian_user)
        url = reverse('catalog:record-create')
        response = client.get(url)
        assert response.status_code == 200
```

### Lors d'une modification de code existant :

1. Identifier les tests existants liés au code modifié
2. Exécuter ces tests AVANT modification (doivent passer)
3. Modifier le code
4. Adapter les tests si le comportement change
5. Ajouter des tests pour les nouveaux cas
6. Tous les tests doivent passer APRÈS modification

### Tests d'accessibilité :

- Utiliser pa11y-ci pour les tests automatisés
- Tester avec axe-core (extension navigateur)
- Tests manuels avec NVDA ou VoiceOver

### Exemple de test pour un modèle :

```python
import pytest
from decimal import Decimal
from datetime import date, timedelta
from catalog.models import Loan

@pytest.mark.django_db
class TestLoanModel:
    """Tests pour le modèle Loan."""

    def test_loan_creation(self, reader, item):
        """Test de création d'un prêt."""
        loan = Loan.objects.create(reader=reader, item=item)
        assert loan.pk is not None
        assert loan.status == 'active'

    def test_is_overdue_returns_true_when_past_due_date(self, loan_factory):
        """Test qu'un prêt en retard est détecté."""
        loan = loan_factory(due_date=date.today() - timedelta(days=1))
        assert loan.is_overdue is True

    def test_calculate_fine_returns_correct_amount(self, overdue_loan):
        """Test du calcul d'amende."""
        fine = overdue_loan.calculate_fine()
        assert isinstance(fine, Decimal)
        assert fine > Decimal('0')
```

---

## 7. TEMPLATES HTML

### Structure de base :

```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} | MediaBib</title>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>
    
    <header role="banner">
        <nav role="navigation" aria-label="Navigation principale">
            <!-- Menu -->
        </nav>
    </header>
    
    <main id="main-content" role="main">
        <nav aria-label="Fil d'Ariane">
            <!-- Breadcrumb -->
        </nav>
        
        {% block content %}{% endblock %}
    </main>
    
    <footer role="contentinfo">
        <!-- Footer -->
    </footer>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
```

### Messages Django accessibles :

```html
{% if messages %}
<div role="status" aria-live="polite">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}" role="alert">
        {{ message }}
        <button type="button" aria-label="Fermer ce message">×</button>
    </div>
    {% endfor %}
</div>
{% endif %}
```

---

## 8. JAVASCRIPT

### Règles :

- Vanilla JS préféré (éviter les frameworks lourds)
- Progressive enhancement : le site doit fonctionner sans JS
- Accessibilité : gérer le focus, les annonces ARIA

### Exemple accessible :

```javascript
/**
 * Ouvre/ferme un menu déroulant de manière accessible.
 * @param {HTMLElement} button - Le bouton déclencheur
 * @param {HTMLElement} menu - Le menu à afficher
 */
function toggleMenu(button, menu) {
    const isExpanded = button.getAttribute('aria-expanded') === 'true';
    
    button.setAttribute('aria-expanded', !isExpanded);
    menu.hidden = isExpanded;
    
    if (!isExpanded) {
        // Focus sur le premier élément du menu
        const firstItem = menu.querySelector('a, button');
        if (firstItem) firstItem.focus();
    }
}

// Fermer avec Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        // Fermer les menus ouverts
    }
});
```

---

## 9. BASE DE DONNÉES

### Migrations :

- Toujours créer une migration après modification des modèles
- Nommer les migrations de manière descriptive
- Tester les migrations avant commit

```bash
python manage.py makemigrations --name add_isbn_field_to_record
```

### Optimisation :

- Utiliser select_related() pour les ForeignKey
- Utiliser prefetch_related() pour les ManyToMany
- Ajouter des index sur les champs fréquemment recherchés
- Éviter les requêtes N+1

```python
# Mauvais
for loan in Loan.objects.all():
    print(loan.reader.name)  # N+1 requêtes

# Bon
for loan in Loan.objects.select_related('reader'):
    print(loan.reader.name)  # 1 seule requête
```

---

## 10. GIT ET COMMITS

### Format des commits :

```
type(scope): description courte

Corps du message (optionnel)

Refs: #123
```

Types :
- feat: Nouvelle fonctionnalité
- fix: Correction de bug
- docs: Documentation
- style: Formatage (pas de changement de code)
- refactor: Refactoring
- test: Ajout de tests
- chore: Maintenance

### Exemple :

```
feat(catalog): ajouter la recherche avancée par ISBN

- Ajout du champ ISBN dans le formulaire de recherche
- Validation du format ISBN-10 et ISBN-13
- Tests unitaires pour la validation

Refs: #42
```

### Branches :

- main : Production stable
- develop : Développement
- feature/nom-feature : Nouvelles fonctionnalités
- fix/nom-bug : Corrections de bugs

---

## 10bis. CHANGELOG

### Obligation : Mettre à jour le CHANGELOG à chaque modification

Le fichier `CHANGELOG.md` DOIT être mis à jour pour chaque changement notable.

### Format : Keep a Changelog + Semantic Versioning

- Suivre le format [Keep a Changelog](https://keepachangelog.com/fr/1.1.0/)
- Utiliser [Semantic Versioning](https://semver.org/lang/fr/) : MAJOR.MINOR.PATCH

### Catégories du CHANGELOG :

| Catégorie | Description | Exemple |
|-----------|-------------|---------|
| `Added` | Nouvelles fonctionnalités | Ajout de la recherche avancée |
| `Changed` | Modifications de fonctionnalités | Refonte de l'interface de prêt |
| `Deprecated` | Fonctionnalités obsolètes | Ancienne API v1 |
| `Removed` | Fonctionnalités supprimées | Support IE11 |
| `Fixed` | Corrections de bugs | Correction du calcul d'amende |
| `Security` | Corrections de sécurité | Faille XSS corrigée |

### Quand mettre à jour le CHANGELOG :

1. **Nouvelle fonctionnalité** → Ajouter dans `Added`
2. **Modification de comportement** → Ajouter dans `Changed`
3. **Correction de bug** → Ajouter dans `Fixed`
4. **Faille de sécurité** → Ajouter dans `Security`

### Processus :

```
┌─────────────────────────────────────────────────────────────┐
│  1. Développer la fonctionnalité                            │
│  2. Écrire les tests                                        │
│  3. Mettre à jour CHANGELOG.md (section [Unreleased])       │
│  4. Commit avec message conventionnel                       │
└─────────────────────────────────────────────────────────────┘
```

### Exemple d'entrée CHANGELOG :

```markdown
## [Unreleased]

### Added
- Recherche avancée par ISBN dans le catalogue (#42)
- Export des résultats de recherche en CSV

### Fixed
- Correction du calcul des amendes pour les jours fériés (#38)
```

### Lors d'une release :

1. Renommer `[Unreleased]` en `[X.Y.Z] - YYYY-MM-DD`
2. Créer une nouvelle section `[Unreleased]` vide
3. Mettre à jour les liens de comparaison en bas du fichier

---

## 11. AVANT CHAQUE COMMIT

Vérifier systématiquement :

1. ✅ Tests passent : `pytest`
2. ✅ Linting OK : `flake8`
3. ✅ Formatage OK : `black --check .`
4. ✅ Imports triés : `isort --check-only .`
5. ✅ Pas de secrets dans le code
6. ✅ Migrations créées si modèles modifiés
7. ✅ Accessibilité vérifiée sur les nouvelles pages

---

## 12. CHECKLIST NOUVELLE FONCTIONNALITÉ

Avant de considérer une fonctionnalité comme terminée :

- [ ] Code respecte PEP 8
- [ ] Docstrings sur toutes les fonctions/classes
- [ ] Tests unitaires écrits (couverture ≥ 80%)
- [ ] Tests d'intégration si nécessaire
- [ ] Interface accessible (ARIA, clavier, contraste)
- [ ] Design responsive testé
- [ ] Validation côté serveur
- [ ] Protection CSRF active
- [ ] Permissions vérifiées
- [ ] Messages utilisateur clairs et accessibles
- [ ] Documentation mise à jour si nécessaire

---

## 13. RESSOURCES

- WCAG 2.1 : https://www.w3.org/WAI/WCAG21/quickref/
- RGAA : https://accessibilite.numerique.gouv.fr/
- Django Docs : https://docs.djangoproject.com/
- PEP 8 : https://peps.python.org/pep-0008/
- UNIMARC : https://www.transition-bibliographique.fr/unimarc/

---

## 14. PERFORMANCE

### Checklist Frontend

```
□ Images optimisées (WebP, compression, dimensions appropriées)
□ Lazy loading des images (loading="lazy")
□ CSS/JS minifiés en production
□ Critical CSS inline pour le rendu initial
□ Mise en cache des assets (Cache-Control headers)
□ Compression Gzip/Brotli activée
□ Fonts optimisées (font-display: swap, preload)
□ Pas de ressources bloquantes dans le <head>
□ Score Lighthouse Performance ≥ 90
□ First Contentful Paint < 1.8s
□ Largest Contentful Paint < 2.5s
```

### Checklist Backend

```
□ Requêtes SQL optimisées (pas de N+1)
□ select_related() et prefetch_related() utilisés
□ Index sur les champs fréquemment recherchés
□ Pagination sur toutes les listes (max 50 éléments/page)
□ Mise en cache appropriée (Redis/Memcached)
□ Cache des templates activé en production
□ Requêtes asynchrones si possible (Celery pour les tâches longues)
□ Connexions DB poolées (conn_max_age)
□ Temps de réponse < 200ms pour 95% des requêtes
```

### Configuration Django pour la performance

```python
# settings.py - Production

# Cache
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': config('REDIS_URL'),
    }
}

# Sessions en cache
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'

# Template caching
TEMPLATES[0]['OPTIONS']['loaders'] = [
    ('django.template.loaders.cached.Loader', [
        'django.template.loaders.filesystem.Loader',
        'django.template.loaders.app_directories.Loader',
    ]),
]
```

### Outils de mesure

| Outil | Usage |
|-------|-------|
| **Lighthouse** | Audit performance, accessibilité, SEO |
| **Django Debug Toolbar** | Analyse requêtes SQL en développement |
| **django-silk** | Profiling des requêtes |
| **Sentry** | Monitoring des erreurs et performances |
| **WebPageTest** | Analyse détaillée du chargement |

### Exemple d'optimisation de requête

```python
# ❌ Mauvais : N+1 requêtes
def get_loans_bad():
    loans = Loan.objects.all()
    for loan in loans:
        print(loan.reader.name)      # 1 requête par prêt
        print(loan.item.title)       # 1 requête par prêt

# ✅ Bon : 1 seule requête
def get_loans_good():
    loans = Loan.objects.select_related('reader', 'item').all()
    for loan in loans:
        print(loan.reader.name)      # Pas de requête supplémentaire
        print(loan.item.title)       # Pas de requête supplémentaire
```

---

## 15. DÉPLOIEMENT

### Checklist Pré-Déploiement

```
□ DEBUG = False
□ SECRET_KEY sécurisée et unique (générée, pas celle par défaut)
□ ALLOWED_HOSTS configuré avec le domaine
□ Base de données de production configurée (PostgreSQL)
□ DATABASE_URL correctement défini
□ HTTPS activé (SECURE_SSL_REDIRECT = True)
□ Headers de sécurité actifs (HSTS, X-Frame-Options, etc.)
□ Fichiers statiques collectés (collectstatic)
□ Whitenoise configuré pour les fichiers statiques
□ Logs configurés et fonctionnels
□ Sauvegardes automatiques en place
□ Monitoring configuré (Sentry, New Relic)
□ Variables d'environnement vérifiées
□ Migrations appliquées
□ Tests passent en environnement de staging
□ Plan de rollback préparé
```

### Checklist Post-Déploiement

```
□ Site accessible via HTTPS
□ Certificat SSL valide (pas d'avertissement)
□ Fonctionnalités critiques testées manuellement
  □ Connexion/Déconnexion
  □ Recherche dans le catalogue
  □ Création/modification de notice
  □ Prêt/Retour
□ Pas d'erreurs dans les logs
□ Performance acceptable (temps de réponse < 500ms)
□ Sauvegardes fonctionnelles (test de restauration)
□ Monitoring opérationnel (alertes reçues)
□ DNS correctement propagé
□ Emails transactionnels fonctionnels
```

### Configuration Production Django

```python
# settings.py - Configuration production

# Sécurité
DEBUG = False
SECRET_KEY = config('SECRET_KEY')  # Jamais la valeur par défaut
ALLOWED_HOSTS = config('ALLOWED_HOSTS', cast=Csv())

# HTTPS
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

# Cookies
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SESSION_COOKIE_HTTPONLY = True
CSRF_COOKIE_HTTPONLY = True

# HSTS
SECURE_HSTS_SECONDS = 31536000  # 1 an
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# Headers
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'
SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'

# Logging
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'ERROR',
            'class': 'logging.FileHandler',
            'filename': '/var/log/mediabib/error.log',
        },
        'sentry': {
            'level': 'ERROR',
            'class': 'sentry_sdk.integrations.logging.EventHandler',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'sentry'],
            'level': 'ERROR',
            'propagate': True,
        },
    },
}
```

### Commandes de déploiement

```bash
# 1. Mise à jour du code
git pull origin main

# 2. Installation des dépendances
pip install -r requirements.txt

# 3. Migrations
python manage.py migrate --no-input

# 4. Collecte des fichiers statiques
python manage.py collectstatic --no-input

# 5. Redémarrage du serveur
sudo systemctl restart gunicorn
sudo systemctl restart nginx

# 6. Vérification
curl -I https://votre-domaine.fr
```

### Rollback en cas de problème

```bash
# 1. Revenir à la version précédente
git checkout <commit-precedent>

# 2. Réinstaller les dépendances
pip install -r requirements.txt

# 3. Rollback des migrations si nécessaire
python manage.py migrate <app_name> <migration_precedente>

# 4. Redémarrer
sudo systemctl restart gunicorn
```

---

## 16. DOCUMENTATION

### Documents Requis

| Document | Emplacement | Contenu |
|----------|-------------|---------|
| **README.md** | Racine | Installation, configuration, démarrage rapide |
| **CHANGELOG.md** | Racine | Historique des versions (Keep a Changelog) |
| **CONTRIBUTING.md** | Racine | Guide de contribution |
| **docs/API.md** | docs/ | Documentation des endpoints API |
| **docs/ARCHITECTURE.md** | docs/ | Diagrammes et décisions techniques |
| **docs/USER_GUIDE.md** | docs/ | Manuel utilisateur |
| **docs/ADMIN_GUIDE.md** | docs/ | Guide d'administration |

### Checklist Documentation

```
□ README.md à jour avec :
  □ Description du projet
  □ Prérequis (Python, PostgreSQL, etc.)
  □ Instructions d'installation pas à pas
  □ Variables d'environnement documentées
  □ Commandes de base (runserver, migrate, test)
  □ Liens vers la documentation détaillée

□ CHANGELOG.md à jour avec :
  □ Section [Unreleased] pour les changements en cours
  □ Format Keep a Changelog respecté
  □ Liens de comparaison GitHub

□ Documentation API :
  □ Tous les endpoints documentés
  □ Paramètres de requête décrits
  □ Exemples de réponse fournis
  □ Codes d'erreur listés
  □ Authentification expliquée

□ Docstrings dans le code :
  □ Toutes les fonctions publiques documentées
  □ Toutes les classes documentées
  □ Format Google/NumPy respecté
```

### Template README.md

```markdown
# Nom du Projet

Description courte du projet.

## Prérequis

- Python 3.10+
- PostgreSQL 14+
- Node.js 18+ (pour les assets)

## Installation

1. Cloner le projet
2. Créer l'environnement virtuel
3. Installer les dépendances
4. Configurer les variables d'environnement
5. Appliquer les migrations
6. Lancer le serveur

## Configuration

| Variable | Description | Défaut |
|----------|-------------|--------|
| SECRET_KEY | Clé secrète Django | *requis* |
| DEBUG | Mode debug | False |
| DATABASE_URL | URL de connexion BDD | sqlite:///db.sqlite3 |

## Utilisation

...

## Tests

...

## Contribuer

Voir [CONTRIBUTING.md](CONTRIBUTING.md)

## Licence

...
```

### Documentation API avec drf-spectacular

```python
# settings.py
SPECTACULAR_SETTINGS = {
    'TITLE': 'MediaBib API',
    'DESCRIPTION': 'API du système de gestion de bibliothèque',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
}

# urls.py
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView

urlpatterns = [
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    path('api/docs/', SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
]
```

### Commentaires de Code

```python
# ✅ Bon commentaire : explique POURQUOI
def calculate_fine(loan):
    """
    Calcule l'amende pour un prêt en retard.
    
    Le calcul utilise un tarif dégressif après 7 jours
    pour encourager le retour rapide des documents.
    """
    # Tarif réduit après 7 jours car les lecteurs abandonnent souvent
    if days_overdue > 7:
        rate = REDUCED_RATE
    ...

# ❌ Mauvais commentaire : explique QUOI (le code le dit déjà)
def calculate_fine(loan):
    # Calcule l'amende
    fine = days * rate  # Multiplie les jours par le tarif
    return fine
```

---

## 17. MAINTENANCE CONTINUE

### Tâches Hebdomadaires

```
□ Vérifier les alertes de monitoring (Sentry, logs)
□ Revoir les erreurs 500 de la semaine
□ Vérifier l'espace disque et les sauvegardes
□ Mettre à jour les dépendances patch (x.x.PATCH)
□ Vérifier les performances (temps de réponse moyen)
□ Répondre aux issues GitHub/tickets
```

### Tâches Mensuelles

```
□ Audit de sécurité des dépendances
  □ pip-audit ou safety check
  □ npm audit (si applicable)
□ Mettre à jour les dépendances mineures (x.MINOR.x)
□ Revoir les métriques de performance
□ Analyser les logs d'accès (patterns anormaux)
□ Tester la restauration d'une sauvegarde
□ Vérifier les certificats SSL (expiration)
□ Nettoyer les sessions expirées
□ Nettoyer les fichiers temporaires
□ Revoir les issues en attente et prioriser
```

### Tâches Trimestrielles

```
□ Audit d'accessibilité complet (RGAA/WCAG)
□ Mises à jour majeures des dépendances (MAJOR.x.x)
□ Revue de l'architecture et de la dette technique
□ Tests de charge (locust, k6)
□ Test du plan de reprise d'activité (PRA)
□ Revue des permissions et accès utilisateurs
□ Audit de sécurité approfondi
□ Mise à jour de la documentation
□ Formation des utilisateurs si nécessaire
□ Revue des KPIs et objectifs
```

### Tâches Annuelles

```
□ Renouvellement des certificats SSL
□ Revue complète de la sécurité (pentest si budget)
□ Mise à jour majeure du framework (Django LTS)
□ Archivage des anciennes données
□ Revue des coûts d'infrastructure
□ Planification de la roadmap technique
```

### Commandes de Maintenance

```bash
# Vérifier les dépendances obsolètes
pip list --outdated

# Audit de sécurité
pip-audit
safety check

# Nettoyer les sessions expirées
python manage.py clearsessions

# Nettoyer les migrations squashées
python manage.py squashmigrations <app> <start> <end>

# Vérifier les migrations en attente
python manage.py showmigrations

# Sauvegarder la base de données
pg_dump -U user -d mediabib > backup_$(date +%Y%m%d).sql

# Vérifier l'intégrité de la base
python manage.py dbshell
# ANALYZE; VACUUM;
```

### Monitoring et Alertes

```python
# Configuration Sentry
import sentry_sdk
from sentry_sdk.integrations.django import DjangoIntegration

sentry_sdk.init(
    dsn=config('SENTRY_DSN'),
    integrations=[DjangoIntegration()],
    traces_sample_rate=0.1,  # 10% des transactions
    send_default_pii=False,  # RGPD
    environment=config('ENVIRONMENT', default='development'),
)
```

### Checklist Code Review

```
□ Le code fait ce qui est demandé (spec respectée)
□ Pas de code dupliqué (DRY)
□ Nommage clair et cohérent
□ Fonctions courtes (< 20 lignes idéalement)
□ Complexité cyclomatique raisonnable
□ Commentaires utiles (pourquoi, pas quoi)
□ Docstrings sur les fonctions publiques
□ Gestion des erreurs appropriée
□ Pas de console.log / print oubliés
□ Pas de code commenté
□ Pas de TODO sans issue associée
□ Tests présents et pertinents
□ Pas de secrets dans le code
□ Performance acceptable
□ Accessibilité respectée (si frontend)
```

### Pre-commit Hooks

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
      - id: check-merge-conflict

  - repo: https://github.com/psf/black
    rev: 24.1.0
    hooks:
      - id: black

  - repo: https://github.com/pycqa/isort
    rev: 5.13.0
    hooks:
      - id: isort

  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8

  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.7
    hooks:
      - id: bandit
        args: ['-c', 'pyproject.toml']
```

### Installation des pre-commit hooks

```bash
pip install pre-commit
pre-commit install
pre-commit run --all-files  # Vérification initiale
```

---

## 18. CHECKLIST RÉCAPITULATIVE

### À chaque fonctionnalité

```
□ Code propre et documenté
□ Tests écrits et passants (couverture ≥ 80%)
□ Accessibilité vérifiée (ARIA, clavier, contraste)
□ Responsive testé (mobile, tablette, desktop)
□ Sécurité validée (CSRF, XSS, permissions)
□ Performance acceptable (< 200ms)
□ CHANGELOG.md mis à jour
□ Documentation mise à jour
□ Code review approuvée
□ CI/CD vert
```

---

# FIN DES RÈGLES
# Ces règles sont automatiquement appliquées à chaque conversation Cursor.

